<!DOCTYPE html>
<html>
<head>
    <title>Final Debug - Trip Photos Issue</title>
    <style>
        body { font-family: system-ui; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .error { background: #fff0f0; border-color: #ff0000; }
        .success { background: #f0fff0; border-color: #00aa00; }
        .warning { background: #fff8f0; border-color: #ff8800; }
        .info { background: #f0f8ff; border-color: #0088ff; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; max-height: 200px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background: #0056b3; }
        .trip-item { margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        .highlight { background: yellow; font-weight: bold; }
    </style>
</head>
<body>
    <h1>üîß Final Debug - Why Trip 1754449928505-y47bt10sh Has No Photos</h1>
    
    <div class="section info">
        <h2>üéØ Quick Fix Actions</h2>
        <button onclick="openActualTrip()">Open Trip in Wanderplan</button>
        <button onclick="refreshAndRetry()">Refresh Wanderplan & Retry</button>
        <button onclick="checkIfTripIsLoaded()">Check if Trip Loads in App</button>
    </div>
    
    <div class="section" id="trip-status">
        <h2>üìã Trip Status</h2>
        <div id="trip-status-content">Checking...</div>
    </div>
    
    <div class="section" id="api-status">
        <h2>üîß Google API Status</h2>
        <div id="api-status-content">Checking...</div>
    </div>
    
    <div class="section" id="all-trips">
        <h2>üìù All Available Trips</h2>
        <div id="all-trips-content">Loading...</div>
    </div>
    
    <div class="section" id="fix-suggestions">
        <h2>üí° Suggested Fixes</h2>
        <div id="fix-suggestions-content">Analyzing...</div>
    </div>

    <script>
        const TARGET_TRIP_ID = '1754449928505-y47bt10sh';
        
        function openActualTrip() {
            // Open the trip URL directly
            window.open(`http://localhost:5173/trip/${TARGET_TRIP_ID}`, '_blank');
        }
        
        function refreshAndRetry() {
            // Refresh the main app
            const wanderplanWindow = window.open('http://localhost:5173', '_blank');
            setTimeout(() => {
                if (wanderplanWindow && !wanderplanWindow.closed) {
                    wanderplanWindow.location.href = `http://localhost:5173/trip/${TARGET_TRIP_ID}`;
                }
            }, 2000);
        }
        
        function checkIfTripIsLoaded() {
            // Try to access the trip directly and see what happens
            fetch(`http://localhost:5173/trip/${TARGET_TRIP_ID}`)
                .then(response => {
                    const status = document.getElementById('trip-status-content');
                    if (response.ok) {
                        status.innerHTML = '<p class="success">‚úÖ Trip URL responds successfully</p>';
                    } else {
                        status.innerHTML = `<p class="error">‚ùå Trip URL returned ${response.status}</p>`;
                    }
                })
                .catch(error => {
                    const status = document.getElementById('trip-status-content');
                    status.innerHTML = `<p class="error">‚ùå Failed to access trip: ${error.message}</p>`;
                });
        }
        
        function analyzeTripStatus() {
            const trips = JSON.parse(localStorage.getItem('wanderplan_trips') || '[]');
            const places = JSON.parse(localStorage.getItem('wanderplan_places') || '[]');
            const target = trips.find(t => t.id === TARGET_TRIP_ID);
            const targetPlaces = places.filter(p => p.trip_id === TARGET_TRIP_ID);
            
            const content = document.getElementById('trip-status-content');
            
            if (!target) {
                content.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Trip Not Found in localStorage</h3>
                        <p>The trip ID <code>${TARGET_TRIP_ID}</code> does not exist in your browser's data.</p>
                        <p><strong>Possible reasons:</strong></p>
                        <ul>
                            <li>The trip was created in a different browser/device</li>
                            <li>localStorage was cleared</li>
                            <li>The trip ID in the URL is incorrect</li>
                            <li>You're not logged in as the user who created this trip</li>
                        </ul>
                    </div>
                `;
            } else {
                const placesWithPhotos = targetPlaces.filter(p => p.photo_url);
                const placesWithPlaceId = targetPlaces.filter(p => p.place_id);
                
                content.innerHTML = `
                    <div class="success">
                        <h3>‚úÖ Trip Found!</h3>
                        <p><strong>Title:</strong> ${target.title}</p>
                        <p><strong>Destination:</strong> ${target.destination}</p>
                        <p><strong>Places:</strong> ${targetPlaces.length}</p>
                        <p><strong>Places with photos:</strong> ${placesWithPhotos.length}/${targetPlaces.length}</p>
                        <p><strong>Places with place_id:</strong> ${placesWithPlaceId.length}/${targetPlaces.length}</p>
                    </div>
                `;
            }
        }
        
        function analyzeAPIStatus() {
            const content = document.getElementById('api-status-content');
            let html = '';
            
            // Check if Google is available
            if (typeof google !== 'undefined' && google.maps && google.maps.places) {
                html += '<div class="success"><h3>‚úÖ Google Places API Loaded</h3></div>';
            } else {
                html += `
                    <div class="error">
                        <h3>‚ùå Google Places API Not Loaded</h3>
                        <p>This is why photos can't be fetched. The API needs to be loaded first.</p>
                        <p><strong>Solution:</strong> Make sure you're viewing this from within the Wanderplan app.</p>
                    </div>
                `;
            }
            
            content.innerHTML = html;
        }
        
        function showAllTrips() {
            const trips = JSON.parse(localStorage.getItem('wanderplan_trips') || '[]');
            const places = JSON.parse(localStorage.getItem('wanderplan_places') || '[]');
            const content = document.getElementById('all-trips-content');
            
            if (trips.length === 0) {
                content.innerHTML = '<p class="error">‚ùå No trips found. You may need to log in or create trips first.</p>';
                return;
            }
            
            let html = `<p>Found ${trips.length} trips total:</p>`;
            
            trips.forEach(trip => {
                const tripPlaces = places.filter(p => p.trip_id === trip.id);
                const placesWithPhotos = tripPlaces.filter(p => p.photo_url);
                const isTarget = trip.id === TARGET_TRIP_ID;
                
                html += `
                    <div class="trip-item ${isTarget ? 'highlight' : ''}">
                        <h4>${trip.title} ${isTarget ? '‚Üê TARGET TRIP' : ''}</h4>
                        <p><strong>ID:</strong> ${trip.id}</p>
                        <p><strong>Destination:</strong> ${trip.destination}</p>
                        <p><strong>Places:</strong> ${tripPlaces.length} (${placesWithPhotos.length} with photos)</p>
                        <a href="http://localhost:5173/trip/${trip.id}" target="_blank">Open Trip</a>
                    </div>
                `;
            });
            
            content.innerHTML = html;
        }
        
        function generateFixSuggestions() {
            const trips = JSON.parse(localStorage.getItem('wanderplan_trips') || '[]');
            const target = trips.find(t => t.id === TARGET_TRIP_ID);
            const content = document.getElementById('fix-suggestions-content');
            
            let html = '<h3>üîß Recommended Actions:</h3>';
            
            if (!target) {
                html += `
                    <div class="warning">
                        <h4>1. Verify Trip Access</h4>
                        <p>The trip doesn't exist in your current browser data.</p>
                        <button onclick="openActualTrip()">Try Opening Trip URL</button>
                        <p>If this gives a 404 or error, the trip may not exist.</p>
                    </div>
                    
                    <div class="info">
                        <h4>2. Check Login Status</h4>
                        <p>Make sure you're logged in as the user who created this trip.</p>
                        <button onclick="window.open('http://localhost:5173', '_blank')">Go to Wanderplan</button>
                    </div>
                    
                    <div class="info">
                        <h4>3. Alternative Trips</h4>
                        <p>Try one of the other trips that do exist in your data (see list above).</p>
                    </div>
                `;
            } else {
                if (typeof google === 'undefined') {
                    html += `
                        <div class="warning">
                            <h4>1. Google API Not Loaded</h4>
                            <p>Photos can't load because Google Places API isn't initialized.</p>
                            <button onclick="refreshAndRetry()">Refresh Wanderplan App</button>
                        </div>
                    `;
                }
                
                html += `
                    <div class="success">
                        <h4>2. Try Photo Refresh</h4>
                        <p>Open the trip and click the "Add Photos" button.</p>
                        <button onclick="openActualTrip()">Open Trip & Add Photos</button>
                    </div>
                `;
            }
            
            content.innerHTML = html;
        }
        
        // Run all checks on load
        window.addEventListener('load', () => {
            analyzeTripStatus();
            analyzeAPIStatus();
            showAllTrips();
            generateFixSuggestions();
        });
    </script>
</body>
</html>
