<!DOCTYPE html>
<html>
<head>
    <title>Debug New Trip Photos: 1755059599596-vddd4wva4</title>
    <style>
        body { font-family: monospace; padding: 20px; max-width: 1400px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .error { background: #fff0f0; border-color: #ff0000; }
        .success { background: #f0fff0; border-color: #00aa00; }
        .warning { background: #fff8f0; border-color: #ff8800; }
        .info { background: #f0f8ff; border-color: #0088ff; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; max-height: 300px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background: #0056b3; }
        .place-item { margin: 10px 0; padding: 15px; border: 1px solid #ccc; border-radius: 8px; }
        .has-photo { border-color: green; background: #f9fff9; }
        .no-photo { border-color: red; background: #fff9f9; }
        .has-place-id { border-color: orange; background: #fffaf0; }
        img { max-width: 150px; max-height: 150px; object-fit: cover; border-radius: 4px; margin: 10px 0; }
        .photo-test { margin: 10px 0; padding: 10px; background: #f0f0f0; border-radius: 4px; }
        .console-logs { background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 4px; max-height: 200px; overflow-y: auto; font-family: 'Courier New', monospace; }
    </style>
</head>
<body>
    <h1>üîç Debug New Trip Photos: 1755059599596-vddd4wva4</h1>
    
    <div class="section info">
        <h2>üéØ Quick Actions</h2>
        <button onclick="openTrip()">Open Trip in Wanderplan</button>
        <button onclick="refreshAndAnalyze()">Refresh Analysis</button>
        <button onclick="testPhotoRefresh()">Test "Add Photos" Feature</button>
        <button onclick="clearConsole()">Clear Console</button>
    </div>
    
    <div class="section">
        <h2>üìä Trip Overview</h2>
        <div id="trip-overview">Loading...</div>
    </div>
    
    <div class="section">
        <h2>üîß API & Environment Status</h2>
        <div id="api-status">Checking...</div>
        <button onclick="testAPIStatus()">Test API Status</button>
    </div>
    
    <div class="section">
        <h2>üìù Places Analysis</h2>
        <div id="places-analysis">Loading...</div>
    </div>
    
    <div class="section">
        <h2>üß™ Photo Generation Test</h2>
        <div id="photo-test-results">Click buttons above to test...</div>
    </div>
    
    <div class="section">
        <h2>üìã Console Output</h2>
        <div id="console-output" class="console-logs">Console logs will appear here...</div>
    </div>

    <script>
        const TRIP_ID = '1755059599596-vddd4wva4';
        let consoleOutput = [];
        
        // Capture console logs
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addToConsole(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            consoleOutput.push(`[${timestamp}] ${type}: ${message}`);
            updateConsoleDisplay();
        }
        
        console.log = function(...args) {
            addToConsole('LOG', args.join(' '));
            originalLog.apply(console, args);
        };
        console.error = function(...args) {
            addToConsole('ERROR', args.join(' '));
            originalError.apply(console, args);
        };
        console.warn = function(...args) {
            addToConsole('WARN', args.join(' '));
            originalWarn.apply(console, args);
        };
        
        function updateConsoleDisplay() {
            const display = document.getElementById('console-output');
            display.innerHTML = consoleOutput.slice(-20).join('\n');
            display.scrollTop = display.scrollHeight;
        }
        
        function clearConsole() {
            consoleOutput = [];
            updateConsoleDisplay();
        }
        
        function openTrip() {
            window.open(`http://localhost:5173/trip/${TRIP_ID}`, '_blank');
        }
        
        function analyzeTripData() {
            console.log('üîç Analyzing trip data...');
            
            const trips = JSON.parse(localStorage.getItem('wanderplan_trips') || '[]');
            const places = JSON.parse(localStorage.getItem('wanderplan_places') || '[]');
            
            const trip = trips.find(t => t.id === TRIP_ID);
            const tripPlaces = places.filter(p => p.trip_id === TRIP_ID);
            
            const overview = document.getElementById('trip-overview');
            
            if (!trip) {
                overview.innerHTML = '<div class="error">‚ùå Trip not found!</div>';
                return;
            }
            
            const placesWithPhotos = tripPlaces.filter(p => p.photo_url);
            const placesWithPlaceId = tripPlaces.filter(p => p.place_id);
            
            overview.innerHTML = `
                <div class="success">
                    <h3>‚úÖ Trip Found: ${trip.title}</h3>
                    <p><strong>Destination:</strong> ${trip.destination}</p>
                    <p><strong>Created:</strong> ${new Date(parseInt(trip.id.split('-')[0])).toLocaleString()}</p>
                    <p><strong>Total Places:</strong> ${tripPlaces.length}</p>
                    <p><strong>Places with Photos:</strong> ${placesWithPhotos.length}/${tripPlaces.length}</p>
                    <p><strong>Places with Google Place ID:</strong> ${placesWithPlaceId.length}/${tripPlaces.length}</p>
                    
                    ${placesWithPhotos.length === 0 ? 
                        '<div class="error"><strong>üö® ISSUE: No places have photos!</strong></div>' :
                        placesWithPhotos.length < tripPlaces.length ?
                        '<div class="warning"><strong>‚ö†Ô∏è PARTIAL: Some places missing photos</strong></div>' :
                        '<div class="success"><strong>‚úÖ All places have photos!</strong></div>'
                    }
                </div>
            `;
            
            analyzePlaces(tripPlaces);
        }
        
        function analyzePlaces(places) {
            const analysis = document.getElementById('places-analysis');
            
            if (places.length === 0) {
                analysis.innerHTML = '<div class="error">‚ùå No places found!</div>';
                return;
            }
            
            let html = `<h3>Detailed Places Analysis (${places.length} places):</h3>`;
            
            places.forEach((place, index) => {
                const hasPhoto = !!place.photo_url;
                const hasPlaceId = !!place.place_id;
                
                let className = 'no-photo';
                let status = '‚ùå No photo, no place_id';
                
                if (hasPhoto) {
                    className = 'has-photo';
                    status = '‚úÖ Has photo';
                } else if (hasPlaceId) {
                    className = 'has-place-id';
                    status = 'üü° Has place_id, no photo';
                }
                
                html += `
                    <div class="place-item ${className}">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <h4>${place.name} (Day ${place.day})</h4>
                                <p><strong>Status:</strong> ${status}</p>
                                <p><strong>Category:</strong> ${place.category}</p>
                                <p><strong>Address:</strong> ${place.address || 'No address'}</p>
                                ${hasPlaceId ? `<p><strong>Place ID:</strong> ${place.place_id}</p>` : ''}
                                ${hasPhoto ? `<p><strong>Photo URL:</strong> <span style="word-break: break-all; font-size: 10px;">${place.photo_url}</span></p>` : ''}
                            </div>
                            <div style="text-align: center;">
                                ${hasPhoto ? `
                                    <img src="${place.photo_url}" 
                                         alt="${place.name}"
                                         onload="this.parentElement.innerHTML += '<p style=color:green;font-size:12px>‚úÖ Loads</p>'"
                                         onerror="this.parentElement.innerHTML += '<p style=color:red;font-size:12px>‚ùå Failed</p>'" />
                                ` : '<div style="width: 150px; height: 100px; background: #eee; display: flex; align-items: center; justify-content: center; border-radius: 4px;">No Photo</div>'}
                            </div>
                        </div>
                        
                        <div style="margin-top: 10px;">
                            ${hasPlaceId ? `
                                <button onclick="testSinglePlacePhoto('${place.id}', '${place.place_id}', '${place.name.replace(/'/g, "\\'")}')">
                                    üîç Test Photo Fetch
                                </button>
                            ` : `
                                <button onclick="searchPlaceOnGoogle('${place.name.replace(/'/g, "\\'")}', '${place.trip_id}')">
                                    üîç Search on Google
                                </button>
                            `}
                        </div>
                    </div>
                `;
            });
            
            analysis.innerHTML = html;
        }
        
        function testAPIStatus() {
            console.log('üîß Testing API status...');
            const status = document.getElementById('api-status');
            
            let html = '<h3>API Status Check:</h3>';
            
            // Check Google Maps API
            const hasGoogle = typeof google !== 'undefined';
            const hasMaps = hasGoogle && google.maps;
            const hasPlaces = hasMaps && google.maps.places;
            const hasPlacesService = hasPlaces && google.maps.places.PlacesService;
            
            html += `<p>Google object: ${hasGoogle ? '‚úÖ' : '‚ùå'}</p>`;
            html += `<p>Google Maps: ${hasMaps ? '‚úÖ' : '‚ùå'}</p>`;
            html += `<p>Google Places: ${hasPlaces ? '‚úÖ' : '‚ùå'}</p>`;
            html += `<p>PlacesService: ${hasPlacesService ? '‚úÖ' : '‚ùå'}</p>`;
            
            // Check network
            html += `<p>Online: ${navigator.onLine ? '‚úÖ' : '‚ùå'}</p>`;
            
            // Check CORS
            html += `<p>Origin: ${window.location.origin}</p>`;
            
            if (!hasGoogle) {
                html += '<div class="error"><p><strong>üö® CRITICAL: Google Maps API not loaded!</strong></p><p>This is why photos aren\'t working. The API must be loaded within the Wanderplan app.</p></div>';
            } else if (!hasPlacesService) {
                html += '<div class="error"><p><strong>üö® CRITICAL: Google Places Service not available!</strong></p></div>';
            } else {
                html += '<div class="success"><p><strong>‚úÖ Google Places API is ready!</strong></p></div>';
            }
            
            status.innerHTML = html;
        }
        
        async function testSinglePlacePhoto(placeId, googlePlaceId, placeName) {
            console.log(`üß™ Testing photo for: ${placeName}`);
            const results = document.getElementById('photo-test-results');
            
            if (typeof google === 'undefined' || !google.maps || !google.maps.places) {
                results.innerHTML = '<div class="error">‚ùå Google Places API not available for testing</div>';
                return;
            }
            
            results.innerHTML = `<p>üîç Testing photo fetch for: <strong>${placeName}</strong></p>`;
            
            try {
                const div = document.createElement('div');
                const service = new google.maps.places.PlacesService(div);
                
                const request = {
                    placeId: googlePlaceId,
                    fields: ['photos', 'name', 'place_id', 'formatted_address']
                };
                
                service.getDetails(request, (place, status) => {
                    console.log(`Google Places API response for ${placeName}:`, status, place);
                    
                    if (status === google.maps.places.PlacesServiceStatus.OK && place) {
                        if (place.photos && place.photos.length > 0) {
                            const photoUrl = place.photos[0].getUrl({ maxWidth: 400, maxHeight: 300 });
                            results.innerHTML += `
                                <div class="success">
                                    <p>‚úÖ Found ${place.photos.length} photos for: ${place.name}</p>
                                    <img src="${photoUrl}" alt="${place.name}" style="max-width: 200px;" />
                                    <p style="font-size: 12px; word-break: break-all;">URL: ${photoUrl}</p>
                                </div>
                            `;
                            console.log(`‚úÖ Photo found for ${placeName}: ${photoUrl}`);
                        } else {
                            results.innerHTML += `<div class="warning">‚ö†Ô∏è Place found but no photos available for: ${place.name}</div>`;
                            console.warn(`‚ö†Ô∏è No photos for ${placeName}`);
                        }
                    } else {
                        results.innerHTML += `<div class="error">‚ùå Failed to get place details: ${status}</div>`;
                        console.error(`‚ùå Place details failed for ${placeName}: ${status}`);
                    }
                });
            } catch (error) {
                results.innerHTML += `<div class="error">‚ùå Error: ${error.message}</div>`;
                console.error(`‚ùå Error testing ${placeName}:`, error);
            }
        }
        
        async function searchPlaceOnGoogle(placeName, tripId) {
            console.log(`üîç Searching Google for: ${placeName}`);
            const results = document.getElementById('photo-test-results');
            
            if (typeof google === 'undefined' || !google.maps || !google.maps.places) {
                results.innerHTML = '<div class="error">‚ùå Google Places API not available</div>';
                return;
            }
            
            // Get trip destination
            const trips = JSON.parse(localStorage.getItem('wanderplan_trips') || '[]');
            const trip = trips.find(t => t.id === tripId);
            const destination = trip ? trip.destination : '';
            
            results.innerHTML = `<p>üîç Searching for: <strong>${placeName}</strong> in ${destination}</p>`;
            
            try {
                const div = document.createElement('div');
                const service = new google.maps.places.PlacesService(div);
                
                const request = {
                    query: `${placeName} ${destination}`,
                    fields: ['photos', 'name', 'place_id', 'formatted_address']
                };
                
                service.textSearch(request, (results_list, status) => {
                    console.log(`Google Places search for "${placeName} ${destination}":`, status, results_list);
                    
                    if (status === google.maps.places.PlacesServiceStatus.OK && results_list && results_list.length > 0) {
                        const place = results_list[0];
                        results.innerHTML += `
                            <div class="success">
                                <p>‚úÖ Found: ${place.name}</p>
                                <p>Address: ${place.formatted_address}</p>
                                <p>Place ID: ${place.place_id}</p>
                        `;
                        
                        if (place.photos && place.photos.length > 0) {
                            const photoUrl = place.photos[0].getUrl({ maxWidth: 400, maxHeight: 300 });
                            results.innerHTML += `
                                <img src="${photoUrl}" alt="${place.name}" style="max-width: 200px;" />
                                <p style="font-size: 12px;">‚úÖ Photo available!</p>
                            `;
                            console.log(`‚úÖ Photo found via search for ${placeName}: ${photoUrl}`);
                        } else {
                            results.innerHTML += '<p>‚ö†Ô∏è No photos available</p>';
                            console.warn(`‚ö†Ô∏è No photos in search results for ${placeName}`);
                        }
                        
                        results.innerHTML += '</div>';
                    } else {
                        results.innerHTML += `<div class="error">‚ùå No search results found: ${status}</div>`;
                        console.error(`‚ùå Search failed for ${placeName}: ${status}`);
                    }
                });
            } catch (error) {
                results.innerHTML += `<div class="error">‚ùå Search error: ${error.message}</div>`;
                console.error(`‚ùå Search error for ${placeName}:`, error);
            }
        }
        
        function testPhotoRefresh() {
            console.log('üß™ Testing photo refresh functionality...');
            const results = document.getElementById('photo-test-results');
            
            results.innerHTML = `
                <div class="info">
                    <h3>üß™ Photo Refresh Test</h3>
                    <p>This will simulate clicking the "Add Photos" button:</p>
                    <ol>
                        <li>Open the trip in Wanderplan</li>
                        <li>Look for the "Add Photos" button next to "Add Item"</li>
                        <li>Click it and watch the console for progress</li>
                        <li>Photos should appear after a few seconds</li>
                    </ol>
                    <button onclick="openTrip()">Open Trip to Test</button>
                </div>
            `;
        }
        
        function refreshAndAnalyze() {
            console.log('üîÑ Refreshing analysis...');
            analyzeTripData();
            testAPIStatus();
        }
        
        // Auto-run analysis on load
        window.addEventListener('load', () => {
            console.log('üöÄ Debug tool loaded for trip:', TRIP_ID);
            analyzeTripData();
            testAPIStatus();
        });
    </script>
</body>
</html>
